name: Sync to Google Drive

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install rclone
        run: |
          RCLONE_VERSION="v1.68.2"
          curl -fsSL "https://github.com/rclone/rclone/releases/download/${RCLONE_VERSION}/rclone-${RCLONE_VERSION}-linux-amd64.deb" -o /tmp/rclone.deb
          sudo dpkg -i /tmp/rclone.deb
          rm /tmp/rclone.deb

      - name: Configure rclone
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<'RCLONE_EOF'
          [gdrive]
          type = drive
          scope = drive
          service_account_file = /tmp/sa.json
          RCLONE_EOF
          echo '${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}' > /tmp/sa.json
          chmod 600 /tmp/sa.json

      - name: Sync project files
        run: |
          rclone copy . gdrive:AI574_Multi_Domain_Agent/project/ \
            --include "config/**" \
            --include "foundation/**" \
            --include "agents/**" \
            --include "orchestration/**" \
            --include "rag_core/**" \
            --include "ingestion/**" \
            --include "evaluation/**" \
            --include "notebooks/**" \
            --include "requirements.txt" \
            --exclude "__pycache__/**" \
            --exclude "*.pyc" \
            --exclude ".git/**" \
            -v

      - name: Cleanup
        if: always()
        run: rm -f /tmp/sa.json
